---
services:
  immich-server:
    image: ghcr.io/immich-app/immich-server:release
    container_name: immich
    user: 1000:1000
    security_opt:
      - apparmor:unconfined
    environment:
      - TZ=Europe/Zagreb
      - REDIS_HOSTNAME=${REDIS_HOSTNAME}
      - REDIS_PORT=6379
      - DB_HOSTNAME=${DB_HOSTNAME}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_DATABASE=${DB_DATABASE}
      # Set permissions to the nfs directory
      # sudo chown -R [user]:users ${UPLOAD_LOCATION}
      - UPLOAD_LOCATION=${UPLOAD_LOCATION}
    ports:
      - 8212:2283
    network_mode: bridge
    restart: always

  immich-machine-learning:
    image: ghcr.io/immich-app/immich-machine-learning:release
    container_name: immich-ml
    security_opt:
      - apparmor:unconfined
    volumes:
      - /etc/docker/immich/upload:/usr/src/app/upload:rw
      - /etc/docker/immich/cache:/cache:rw
      - /etc/docker/immich/matplotlib:/matplotlib:rw
    environment:
      - MPLCONFIGDIR=/matplotlib
    restart: always
